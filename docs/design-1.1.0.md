# 📘 v1.1.0 产品设计文档

**版本**: v1.1.0
**核心主题**: 多策略推送系统 & 灵活配置

---

## 🎯 版本概述

v1.1.0 是一个**功能升级版本**，核心目标是：

1. **引入多策略推送系统** - 支持计数器、批次、日期哈希三种推送策略
2. **策略配置化** - 不同群、不同领域可以使用不同的推送策略
3. **增强灵活性** - 满足不同学习模式（均衡练习、顺序复习、循环复习）的需求
4. **保持兼容性** - 向下兼容 v1.0.x 的批次系统

---

## 📊 功能范围 (Scope)

### 新增功能

#### 1. 多策略推送系统 ⭐ 核心功能

**三种推送策略**：

| 策略名称 | 英文标识 | 适用场景 | 核心特点 |
|---------|---------|---------|---------|
| 计数器策略 | `counter` | 日常均衡练习 | 自动均衡，每道题推送次数最少的优先 |
| 批次策略 | `batch` | 固定顺序复习 | 按预设批次循环推送，支持系统性学习 |
| 日期取余策略 | `daterem` | 无状态循环 | 根据日期自动选择批次，完全无状态 |

**策略切换**：
- 群级别：整个群使用统一策略
- 领域级别（可选）：同一个群的不同领域可以使用不同策略

#### 2. 策略管理指令

| 指令 | 权限 | 功能说明 |
|-----|------|---------|
| `/lstra` | 所有人 | 查看本群当前使用的推送策略及状态 |
| `/stra set <策略名> all/<领域名>` | 管理员 | 切换本群指定领域的推送策略 (counter/batch/daterem) |
| `/stra info <领域名>` | 所有人 | 查看指定领域的推送进度和统计信息 |
| `/stra reset <领域名>` | 管理员 | 重置指定领域的推送进度（仅批次和计数器策略） |

#### 3. 推送统计与可视化

- 计数器策略：显示每道题的推送次数、最后推送时间
- 批次策略：显示当前批次进度、已完成批次数
- 日期取余策略：显示今日批次索引、循环周期

---

## 🗄️ 数据库设计

### 新增字段

#### 1. `group_task_config` - 推送策略配置字段

直接在原有表中新增字段，不引入新表。

```sql
ALTER TABLE group_task_config
ADD COLUMN strategy_type TEXT DEFAULT 'batch'
CHECK(strategy_type IN ('counter', 'batch', 'daterem'));
```

**字段说明**：
- `strategy_type`: 策略类型 (counter/batch/daterem)

#### 2. `problem_push_count` - 题目推送计数表（计数器策略专用）

```sql
CREATE TABLE IF NOT EXISTS problem_push_count (
    group_qq TEXT NOT NULL,
    problem_id INTEGER NOT NULL,
    push_count INTEGER DEFAULT 0,
    last_push_time DATETIME,
    PRIMARY KEY (group_qq, problem_id),
    FOREIGN KEY (problem_id) REFERENCES problems(id)
);

CREATE INDEX IF NOT EXISTS idx_push_count_lookup 
ON problem_push_count(group_qq, push_count);
```

**字段说明**：
- `group_qq`: 群号
- `problem_id`: 题目 ID
- `push_count`: 推送次数
- `last_push_time`: 最后推送时间

### 保留表

以下表保留用于批次策略：
- `domain_settings` - 批次配置表
- `group_task_config.now_cursor` - 游标字段

---

## 🔧 技术设计

### 架构模式：策略模式 (Strategy Pattern)

#### 1. 策略抽象接口 (`PushStrategy`)

-   定义了策略的统一接口，包括获取题目 (`get_problems_to_push`)、推送成功回调 (`on_push_success`) 和获取策略状态 (`get_strategy_info`)。

#### 2. 策略工厂 (`StrategyFactory`)

-   负责根据数据库配置的 `strategy_type` 创建具体的策略实例。
-   支持 `counter` (计数器)、`batch` (批次)、`daterem` (日期取余) 三种策略。

#### 3. 调度器集成 (`QuizScheduler`)

-   `_push_callback` 不再包含具体的题目选择逻辑。
-   通过 `StrategyFactory` 获取策略实例，委托策略执行题目获取和状态更新。

---

## 📋 策略详细说明

### 策略一：计数器策略 (CounterStrategy)

#### 核心逻辑

-   每次推送时，查询该群每道题的推送次数，**优先推送次数最少的题目**。
-   在次数相同时，按题目 ID 顺序排列，保证确定性。

#### 优点

✅ **自动均衡** - 无需配置，新增题目自动融入
✅ **实时响应** - 题目数量变化时立即生效
✅ **推送均匀** - 每道题推送次数差异最小
✅ **故障恢复** - 推送失败不增加计数，下次自动重试

#### 缺点

❌ **存储开销** - 题数 × 群数（小规模可接受）
❌ **无固定顺序** - 不适合需要系统性复习的场景

---

### 策略二：批次策略 (BatchStrategy) - 保持兼容

#### 核心逻辑

-   **保持 v1.0.x 的批次系统不变**，按预设批次顺序循环推送。
-   使用 `now_cursor` 记录当前批次的起始位置。
-   推送成功后，游标移动到下一批次；如果已是最后一批，则循环回到第一批。

#### 优点

✅ **固定顺序** - 适合系统性学习
✅ **向下兼容** - 完全兼容 v1.0.x 配置

#### 缺点

❌ **需要配置** - 新增题目需要更新批次
❌ **缺乏弹性** - 无法自动适应题库变化

---

### 策略三：日期取余策略 (DateRemainderStrategy) - 轻量无状态

#### 核心逻辑

-   根据**日期自动计算**今天应该推送哪一批，完全无状态。
-   公式 `(days_since_epoch) % total_batches`。

#### 优点

✅ **完全无状态** - 无需存储进度
✅ **幂等性** - 同一天多次推送结果相同
✅ **自动循环** - 无需手动维护

#### 缺点

❌ **需要配置** - 依赖批次配置
❌ **全局一致** - 所有群进度相同（可能不适合某些场景）

---

## 🎨 用户界面设计

### 1. 查看策略状态

**指令**: `/lstra`

**输出格式**:

```
🎯 本群推送策略
策略类型: 计数器策略

📊 各领域状态：
Java (计数器):
  总题数: 120
  累计推送: 450次
  平均每题: 3.8次

Golang (批次):
  当前批次: [11-20]
  进度: 2/5 批次
```

### 2. 切换策略

**指令**: `/stra set counter all` (设置所有领域) 或 `/stra set counter Java` (仅设置 Java 领域)

**输出格式**:

```
✅ 已将 3 个领域的推送策略切换为 [counter]
原有进度已保留，立即生效。
```

或

```
✅ 已将领域 [Java] 的推送策略切换为 [counter]
原有进度已保留，立即生效。
```

### 3. 查看领域进度

**指令**: `/stra info Java`

**计数器策略输出**:

```
📊 Java - 计数器策略

总题数: 120
累计推送: 450次
平均每题: 3.8次
推送分布: 2~5次

📈 推送最少的5道题:
#42 (2次) - JVM 垃圾回收机制
#87 (2次) - Spring AOP 原理
#15 (3次) - HashMap 实现原理
#93 (3次) - MySQL 索引优化
#28 (3次) - 线程池参数详解
```

**批次策略输出**:

```
📚 Java - 批次策略

当前批次: [11-20] (第2批/共5批)
批次内题目: 10道
下次循环: 完成当前批次后进入第3批 [21-30]

📋 批次配置:
第1批: 题目 1-10   (基础概念)
第2批: 题目 11-20  (集合框架) ← 当前
第3批: 题目 21-30  (并发编程)
第4批: 题目 31-40  (JVM 调优)
第5批: 题目 41-50  (Spring 框架)
```

### 4. 重置进度

**指令**: `/stra reset Java`

**输出格式**:

```
✅ 已重置进度
领域: Java
策略: 计数器策略

重置内容:
- 清空所有题目的推送计数
- 重置为初始状态

⚠️ 此操作不可撤销！
```

---

## 🔄 迁移与兼容性

### 从 v1.0.x 升级到 v1.1.0

#### 自动迁移

插件启动时会自动执行以下操作：

1. 检测并创建新表 (`problem_push_count`)
2. 为 `group_task_config` 添加 `strategy_type` 字段，默认 `batch`（保持原有行为）
3. 保留所有批次配置和游标进度

#### 手动配置（可选）

如果希望某些群使用计数器策略：

```bash
# 示例：将群 123456 的 Java 领域切换为计数器策略
/stra set counter
```

### 向下兼容

- ✅ 所有 v1.0.x 的指令保持不变
- ✅ 批次配置 (`domain_settings`) 继续有效
- ✅ 游标进度 (`now_cursor`) 自动保留
- ✅ 原有推送逻辑（批次策略）作为默认策略

---

## 📦 模块结构

```
astrbot_plugin_group_quiz/
├── main.py              # 插件入口
├── scheduler.py         # 调度器（策略化）
├── repository/          # Repository 模式的数据层
│   ├── __init__.py
│   ├── core.py          # 数据库核心 & 连接
│   ├── baseinfo.py      # 基础信息 (Group, User, Domain)
│   ├── problem.py       # 题目操作
│   └── task.py          # 任务配置操作
├── handlers/            # 指令处理器分层
│   ├── __init__.py
│   ├── base.py          # 基类
│   ├── query.py         # 查询类指令
│   ├── user.py          # 用户交互指令
│   ├── admin.py         # 管理员指令
│   └── strategy.py      # 策略管理指令
├── push_strategy/       # 推送策略模块
│   ├── base.py          # 策略抽象基类
│   ├── counter.py       # 计数器策略
│   ├── batch.py         # 批次策略
│   ├── daterem.py       # 日期取余策略
│   └── factory.py       # 策略工厂
└── sql/
    ├── schema.sql       # 数据库表结构
    └── migrate_1.1.0.sql # v1.1.0 迁移脚本
```

---

## 🧪 测试计划

### 功能测试

1. **策略切换测试**
   - 验证三种策略切换的正确性
   - 验证切换后推送逻辑符合预期
   - 验证策略切换不丢失进度

2. **计数器策略测试**
   - 验证推送次数计数准确
   - 验证均衡性（每道题推送次数差异 ≤ 1）
   - 验证新增题目自动融入

3. **批次策略测试**
   - 验证批次循环逻辑
   - 验证 cursor 更新正确性
   - 验证向下兼容性

4. **日期取余策略测试**
   - 验证日期计算准确性
   - 验证幂等性（同一天多次推送结果相同）
   - 验证自动循环

### 性能测试

- **存储开销**: 计数器策略在 100 题 × 10 群场景下的数据库大小
- **查询性能**: 计数器策略在 1000 题情况下的查询耗时
- **并发安全**: 多群同时推送的稳定性

---

## 📚 相关文档

- 📄 [Changelog v1.0.1](../changelogs/v1.0.1.md) - v1.0.1 的修复和改进
- 📄 [Design v1.0.0](./design-1.0.0.md) - 初始版本的产品设计
